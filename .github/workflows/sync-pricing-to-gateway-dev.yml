name: DEV | ync Pricing Configs

on:
  push:
    branches:
      - dev
    paths:
      - 'pricing/**'
  workflow_dispatch:

jobs:
  validate:
    name: Validate Pricing Configs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout models repo
        uses: actions/checkout@v4

      - name: Validate JSON files
        run: |
          echo "════════════════════════════════════════════════════════════"
          echo "  VALIDATING PRICING CONFIGS"
          echo "════════════════════════════════════════════════════════════"
          
          ERRORS=0
          
          for file in pricing/*.json; do
            if ! jq empty "$file" 2>/dev/null; then
              echo "❌ Invalid JSON: $file"
              ERRORS=$((ERRORS + 1))
            else
              echo "✅ $file"
            fi
          done
          
          if [ $ERRORS -gt 0 ]; then
            echo ""
            echo "❌ Validation failed with $ERRORS error(s)"
            exit 1
          fi
          
          echo ""
          echo "✅ All JSON files are valid!"

  trigger-deployments:
    name: DEV | Trigger Deployments
    needs: validate
    runs-on: ubuntu-latest
    environment: DEV_ENVs
    steps:
      - name: Generate GitHub App Token
        id: app_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          owner: portkey-ai
          repositories: winky,gateway-enterprise-node

      - name: DEV | Trigger Winky workflow
        run: |
          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ steps.app_token.outputs.token }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/portkey-ai/winky/actions/workflows/build-pricing-and-deploy.yml/dispatches \
            -d '{"ref":"dev","inputs":{"source_repo":"portkey-ai/models","source_commit":"${{ github.sha }}","triggered_by":"${{ github.actor }}"}}'
          
          echo "✅ Triggered winky build-pricing-and-deploy workflow (staging)"

      - name: DEV | Trigger Gateway workflow
        run: |
          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ steps.app_token.outputs.token }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/portkey-ai/gateway-enterprise-node/actions/workflows/sync-and-deploy.yml/dispatches \
            -d '{"ref":"dev","inputs":{"source_branch":"dev","source_commit":"${{ github.sha }}","triggered_by":"${{ github.actor }}"}}'
          
          echo "✅ Triggered gateway sync-and-deploy workflow (staging)"
